name: Production Deployment

on:
  workflow_dispatch:  # ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶ü‡ßç‡¶∞‡¶ø‡¶ó‡¶æ‡¶∞
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      version:
        description: 'Version to deploy (leave empty for latest)'
        required: false
        type: string
  push:
    tags:
      - 'v*'  # ‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶® ‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶™‡ßÅ‡¶∂ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ö‡¶ü‡ßã ‡¶°‡¶ø‡¶™‡ßç‡¶≤‡¶Ø‡¶º

env:
  DOCKER_REGISTRY: ghcr.io
  DOCKER_IMAGE: ${{ github.repository }}

jobs:
  # ‡ßß. ‡¶™‡ßç‡¶∞‡¶ø-‡¶°‡¶ø‡¶™‡ßç‡¶≤‡¶Ø‡¶º‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶®
  pre-deployment:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      image_tag: ${{ steps.get-version.outputs.image_tag }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        
    - name: Get version information
      id: get-version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
          VERSION="${{ github.event.inputs.version }}"
        elif [ "${{ github.event_name }}" = "push" ]; then
          VERSION="${GITHUB_REF#refs/tags/v}"
        else
          VERSION=$(node -p "require('./package.json').version")
        fi
        
        IMAGE_TAG="${VERSION}-$(git rev-parse --short HEAD)"
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
        
        echo "Deploying version: $VERSION"
        echo "Image tag: $IMAGE_TAG"
        
    - name: Validate configuration
      run: |
        # ‡¶ï‡¶®‡¶´‡¶ø‡¶ó ‡¶´‡¶æ‡¶á‡¶≤ ‡¶ö‡ßá‡¶ï
        if [ ! -f "config/config.example.json" ]; then
          echo "‚ùå config.example.json missing"
          exit 1
        fi
        
        # ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶°‡¶ø‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶∞‡¶ø ‡¶ö‡ßá‡¶ï
        REQUIRED_DIRS=("src/secure" "data" "assets")
        for dir in "${REQUIRED_DIRS[@]}"; do
          if [ ! -d "$dir" ]; then
            echo "‚ùå Directory missing: $dir"
            exit 1
          fi
        done
        
        echo "‚úÖ Configuration validation passed"
        
    - name: Security scan
      uses: anchore/scan-action@v3
      with:
        image: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE }}:latest
        fail-build: false

  # ‡ß®. ‡¶∏‡ßç‡¶ü‡ßá‡¶ú‡¶ø‡¶Ç ‡¶è‡¶®‡¶≠‡¶æ‡¶Ø‡¶º‡¶∞‡¶®‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶™‡ßç‡¶≤‡¶Ø‡¶º
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: pre-deployment
    if: github.event.inputs.environment == 'staging' || github.event_name == 'push'
    
    environment:
      name: staging
      url: https://staging-bot.yourdomain.com
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
        
    - name: Deploy to staging server
      env:
        DEPLOY_HOST: ${{ secrets.STAGING_HOST }}
        DEPLOY_USER: ${{ secrets.STAGING_USER }}
        DEPLOY_PATH: ${{ secrets.STAGING_PATH }}
      run: |
        ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST "
          set -e
          echo 'üöÄ Starting staging deployment...'
          
          cd $DEPLOY_PATH
          
          # ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™
          tar -czf backup-$(date +%Y%m%d-%H%M%S).tar.gz config/ data/ assets/ 2>/dev/null || true
          
          # ‡¶ó‡¶ø‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
          git fetch origin
          git reset --hard origin/main
          
          # ‡¶°‡¶ø‡¶™‡ßá‡¶®‡ßç‡¶°‡ßá‡¶®‡ßç‡¶∏‡¶ø ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶≤
          npm ci --only=production
          
          # ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
          if [ ! -f 'config/config.json' ]; then
            cp config/config.example.json config/config.json
          fi
          
          # ‡¶°‡¶æ‡¶ü‡¶æ ‡¶°‡¶ø‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶∞‡¶ø ‡¶§‡ßà‡¶∞‡¶ø
          mkdir -p data/{fun-json,logs,admin-photos} assets/owner-photos backups
          
          # ‡¶¨‡¶ü ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü
          if pm2 list | grep -q 'messenger-bot'; then
            pm2 restart messenger-bot
          else
            pm2 start main.js --name messenger-bot
          fi
          
          # API ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü
          if pm2 list | grep -q 'bot-api'; then
            pm2 restart bot-api
          else
            pm2 start server/main.js --name bot-api
          fi
          
          echo '‚úÖ Staging deployment completed'
          
          # ‡¶π‡ßá‡¶≤‡¶• ‡¶ö‡ßá‡¶ï
          sleep 10
          curl -f http://localhost:3001/api/health || exit 1
        "

  # ‡ß©. ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶°‡¶ø‡¶™‡ßç‡¶≤‡¶Ø‡¶º
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deployment, deploy-staging]
    if: github.event.inputs.environment == 'production'
    
    environment:
      name: production
      url: https://bot.yourdomain.com
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}
        
    - name: Create production release
      id: create-release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ needs.pre-deployment.outputs.version }}
        release_name: Release v${{ needs.pre-deployment.outputs.version }}
        body: |
          Production deployment
          
          Changes:
          - Automated deployment
          - Version: ${{ needs.pre-deployment.outputs.version }}
          - Commit: ${{ github.sha }}
        draft: false
        prerelease: false
        
    - name: Deploy to production server
      env:
        DEPLOY_HOST: ${{ secrets.PRODUCTION_HOST }}
        DEPLOY_USER: ${{ secrets.PRODUCTION_USER }}
        DEPLOY_PATH: ${{ secrets.PRODUCTION_PATH }}
      run: |
        ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST "
          set -e
          echo 'üöÄ Starting production deployment...'
          
          # ‡¶Æ‡ßá‡¶á‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßá‡¶®‡ßç‡¶∏ ‡¶Æ‡ßã‡¶° ‡¶Ö‡¶® ‡¶ï‡¶∞‡¶æ
          curl -X POST http://localhost:3001/api/system/maintenance -H 'Authorization: Bearer ${{ secrets.BOT_API_TOKEN }}' \
            -d '{\"enabled\": true, \"message\": \"System maintenance in progress\"}' || true
          
          # ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶§‡ßà‡¶∞‡¶ø
          cd $DEPLOY_PATH
          BACKUP_FILE=\"backup-production-\$(date +%Y%m%d-%H%M%S).tar.gz\"
          tar -czf \$BACKUP_FILE config/ data/ assets/ 2>/dev/null || true
          
          # ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡ßá‡¶ü ‡¶∏‡ßá‡¶≠
          cp config/config.json config/config.json.backup
          cp src/secure/owner.lock src/secure/owner.lock.backup
          
          # ‡¶ó‡¶ø‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
          git fetch origin
          git checkout v${{ needs.pre-deployment.outputs.version }}
          
          # ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞
          cp config/config.json.backup config/config.json
          cp src/secure/owner.lock.backup src/secure/owner.lock
          
          # ‡¶°‡¶ø‡¶™‡ßá‡¶®‡ßç‡¶°‡ßá‡¶®‡ßç‡¶∏‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
          npm ci --only=production
          npm audit fix --force || true
          
          # ‡¶¨‡¶ü ‡¶∏‡ßç‡¶ü‡¶™
          pm2 stop messenger-bot bot-api || true
          
          # ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡¶æ‡¶á‡¶ó‡ßç‡¶∞‡ßá‡¶∂‡¶®
          node scripts/migrate.js --from-backup \$BACKUP_FILE || true
          
          # ‡¶¨‡¶ü ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü
          pm2 start main.js --name messenger-bot --update-env
          pm2 start server/main.js --name bot-api --update-env
          
          # ‡¶π‡ßá‡¶≤‡¶• ‡¶ö‡ßá‡¶ï
          echo '‚è≥ Waiting for services to start...'
          sleep 30
          
          for i in {1..10}; do
            if curl -f http://localhost:3001/api/health; then
              echo '‚úÖ Health check passed'
              break
            fi
            sleep 10
          done
          
          # ‡¶Æ‡ßá‡¶á‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßá‡¶®‡ßç‡¶∏ ‡¶Æ‡ßã‡¶° ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ
          curl -X POST http://localhost:3001/api/system/maintenance -H 'Authorization: Bearer ${{ secrets.BOT_API_TOKEN }}' \
            -d '{\"enabled\": false}' || true
          
          echo '‚úÖ Production deployment completed successfully'
          
          # ‡¶Æ‡¶®‡¶ø‡¶ü‡¶∞‡¶ø‡¶Ç ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®
          curl -X POST ${{ secrets.MONITORING_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{\"text\": \"‚úÖ Production deployment successful: v${{ needs.pre-deployment.outputs.version }}\"}'
        "

  # ‡ß™. ‡¶™‡ßã‡¶∏‡ßç‡¶ü-‡¶°‡¶ø‡¶™‡ßç‡¶≤‡¶Ø‡¶º‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶®
  post-deployment:
    name: Post-deployment Validation
    runs-on: ubuntu-latest
    needs: deploy-production
    if: always()
    
    steps:
    - name: Run smoke tests
      run: |
        echo "Running smoke tests..."
        
        # API ‡¶π‡ßá‡¶≤‡¶• ‡¶ö‡ßá‡¶ï
        curl -f https://bot.yourdomain.com/api/health || exit 1
        
        # ‡¶¨‡¶ü ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶ö‡ßá‡¶ï
        curl -f https://bot.yourdomain.com/api/status || exit 1
        
        echo "‚úÖ Smoke tests passed"
        
    - name: Performance test
      uses: matt-ball/newman-action@master
      with:
        collection: tests/postman/performance.json
        environment: tests/postman/production.json
        delayRequest: 1000
        reporters: cli
        
    - name: Generate deployment report
      run: |
        echo "# Deployment Report" > deployment-report.md
        echo "## Summary" >> deployment-report.md
        echo "- Version: ${{ needs.pre-deployment.outputs.version }}" >> deployment-report.md
        echo "- Environment: ${{ github.event.inputs.environment || 'production' }}" >> deployment-report.md
        echo "- Timestamp: $(date)" >> deployment-report.md
        echo "- Status: ${{ job.status }}" >> deployment-report.md
        echo "" >> deployment-report.md
        echo "## Links" >> deployment-report.md
        echo "- Dashboard: https://bot.yourdomain.com/dashboard" >> deployment-report.md
        echo "- API Docs: https://bot.yourdomain.com/api-docs" >> deployment-report.md
        echo "- Monitoring: https://grafana.yourdomain.com" >> deployment-report.md
        
        cat deployment-report.md
        
    - name: Upload deployment report
      uses: actions/upload-artifact@v3
      with:
        name: deployment-report
        path: deployment-report.md

  # ‡ß´. ‡¶∞‡ßã‡¶≤‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ø
  rollback-preparation:
    name: Rollback Preparation
    runs-on: ubuntu-latest
    if: failure() && needs.pre-deployment.result == 'success'
    
    steps:
    - name: Prepare rollback
      env:
        DEPLOY_HOST: ${{ secrets.PRODUCTION_HOST }}
        DEPLOY_USER: ${{ secrets.PRODUCTION_USER }}
        DEPLOY_PATH: ${{ secrets.PRODUCTION_PATH }}
      run: |
        ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST "
          echo 'üîÑ Preparing rollback...'
          
          cd $DEPLOY_PATH
          
          # ‡¶≤‡ßá‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶æ
          LATEST_BACKUP=\$(ls -t backup-production-*.tar.gz 2>/dev/null | head -1)
          
          if [ -n \"\$LATEST_BACKUP\" ]; then
            echo \"Found backup: \$LATEST_BACKUP\"
            echo \"ROLLBACK_FILE=\$LATEST_BACKUP\" >> \$GITHUB_ENV
          else
            echo '‚ùå No backup found for rollback'
            exit 1
          fi
        "
        
    - name: Create rollback issue
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `üö® Rollback required for deployment v${process.env.VERSION}`,
            body: `Deployment failed. Rollback required.\n\nBackup file: ${process.env.ROLLBACK_FILE}`,
            labels: ['rollback', 'urgent']
          })